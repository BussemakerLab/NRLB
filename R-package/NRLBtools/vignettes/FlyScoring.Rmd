---
title: "Scoring fly enhancers using NRLB models"
author: "Chaitanya Rastogi and Harmen J. Bussemaker"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Scoring fly enhancers using NRLB models}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This vignette defines a set of fly enhancers, loads DNA binding specificity models for various Hox complexes, and then visualizes Hox binding affinity profiles along the enhancers. It is related to the paper on the No Read Left Behind (NRLB) algorithm by Rastogi et al., which is currently in revision.

## Defining fly enhancers
We start by defining a number of fly enhancers that were used in the NRLB paper. We will only be using the E3N in this vignette, but the others are included for reference. Note that the version of the fly genome used here is the somewhat outdated `dm3`. The coordinates are only 'guaranteed' to be correct for `dm3`.
```{r}
enh = NRLBtools::fly.enhancers()
names(enh)
enh$E3N
```
## Working with NRLB models for DNA binding specificity
The \code{NRLBtools} package makes it easy to use the DNA binding specicity models that were built from SELEX-seq in vitro binding data using the NRLB algorithm. For now, only the fly ExdHox models are included, but we will add other models in the future. The fly models can be loaded as follows:
```{r}
models = NRLBtools::hox.models()
names(models)
```
## Energy Logo
Let us select a model for a specific heterodimer from our model collection:
```{r}
m = NRLBtools::hox.models()$ExdScr
```
It is always a good idea to visualize the model as an energy logo before using it:
```{r}
NRLBtools::logo(m$fits, m$index, m$mode, m$rc)
```

## Visualizing affinity profiles for enhancers
Finally, we can created an affinity profile along the E3N enhancer as follows:
```{r, fig.show='asis'}
NRLBtools::nrlb.plot.score.genome(enh$E3N$seq, 
                                  m$fits, m$index, m$mode, m$rc,
                                  nPeaks = 10, annotate = TRUE)
```
## Working with genome-wide tracks and bigwig files
For each available fly model, the corresponding genomewide, base-pair-resultion, affinity profile has been precomputed and is available on the Bussemaker Lab webserver (the plan is to add functionality to generate these genomewide affinity profiles within the \code{NRLBtools} package, but this require some significant work, as the current scoring using \code{NRLBtools::score.genome} is too slow).

The precomputed affinity profiles can be fetched from the server in two different formats using \code{fetch.genomic.profiles} or \code{fetch.tracks}. Here, we will illustrate how to create bigwig files using the latter function.

The first step is to fetch the track, in the form of a \code{GRanges} object, this will take several minutes):
```{r}
library(BSgenome.Dmelanogaster.UCSC.dm3)
gr = NRLBtools::fetch.as.track("http://bussemakerlab.org/NRLB/dm3/ExdScr", 
                    genome = BSgenome.Dmelanogaster.UCSC.dm3, chr.names = c("chrXHet", "chrYHet"),
                    model = m, normalize = "model")
```
Note that \code{gr}  contains relative affinity scores for multiple chromosomes and both strands:
```{r}
gr
```
It is important to understand how the affinity scores are normalized. First of all, the scale of the affnities predicted by NRLB models is currently arbitrary. This means that only ratios between two different DNA sequences are meaningful. For instance, consider the optimal binding site for ExdScr, which can be determined as follows using dynamics programming, and note that the NRLB score for this optimal site is not equal to one. 
```{r}
NRLBtools::optimal.site(m$fits, m$index, m$mode)
```
To make the absolute NRLB score more meaningful, it should be properly normalized when constructing genomic tracks. By setting \code{normalize = "model"} in \code{fetch.tracks}, the scores in \code{gr} are normalized relative to the theoretically optimal site. This site may occur in the genome or it may not, so the genomewide maximum of \code{score(gr)} in general is somewhere between zero and one:
```{r}
range(score(gr))
```
It can be useful to save the track as a BigWig file for use in other applications. Note that the \code{gr} object above specifies the exact start and end of the binding site as an integer range. Overlapping ranges are not allowed in BigWig files, so we need to attribute the binding score for each window to a single genomic position by setting the width of the ranges to one:
```{r}
gr.new = gr
width(gr.new) = 1
gr.new
```
Note that this assigns the affinity to the 5'-most position for windows on the forward strand and to the 3'-most position on the reverse strand. An alternative choice (which we recommend) would be to always assign the score to the 5'-most position as follows:
```{r}
gr.new = gr
end(gr.new[strand(gr.new)=="+"]) = start(gr.new[strand(gr.new)=="+"])
start(gr.new[strand(gr.new)=="-"]) = end(gr.new[strand(gr.new)=="-"])
gr.new
```
Bigwig files also do not support strand-specific tracks, so we need to separately save the forward and reverse strand profiles. Moreover, the full genome-wide tracks are too large to be saved in their entirety, and we will want to exclude positions with scores below some (low) threshold. This can be achieved as follows:
```{r}
end(gr[strand(gr)=="+"]) = start(gr[strand(gr)=="+"])
start(gr[strand(gr)=="-"]) = end(gr[strand(gr)=="-"])
bwfile.fwd = tempfile("ExdScr_fwd_", fileext=".bw")
export(gr[score(gr) > 1E-4 & strand(gr)=="+"], bwfile.fwd)
bwfile.rev = tempfile("ExdScr_rev_", fileext=".bw")
export(gr[score(gr) > 1E-4 & strand(gr)=="+"], bwfile.fwd)
```
By loading these files we can check that the affinities are all above threshold:
```{r}
bw = import(bwfile.fwd)
bw
range(score(bw))
```